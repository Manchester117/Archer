<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout">
<head>
    <meta charset="UTF-8"/>
    <title>Archer</title>
</head>
<body>
<div layout:fragment="content">
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-book"></i> 基本信息 </h3>
                </div>
                <div class="panel-body">
                    <input type="hidden" id="project_id" name="projectId" th:value="${projectId}"/>
                    <input type="hidden" id="service_id" name="serviceId" th:value="${apiAndVerifyInfo.serviceId}"/>
                    <input type="hidden" id="api_id" name="apiId" th:value="${apiAndVerifyInfo.id}"/>
                    <div class="form-inline" role="form" style="padding-bottom: 10px">
                        <div class="form-group">
                            <label for="api_name" class="control-label">接口名称:</label>
                            <input id="api_name" class="form-control" name="apiName" placeholder="请输入接口名称" th:value="${apiAndVerifyInfo.apiName}" style="width:900px;"/>
                        </div>
                        <div class="form-group">
                            <label for="protocol" class="control-label">使用协议:</label>
                            <select class="selectpicker protocol" id="protocol" data-width="125px">
                                <option value="1" selected>HTTP</option>
                                <option value="2">HTTPS</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="method" class="control-label">请求方式:</label>
                            <select class="selectpicker method" id="method" data-width="175px">
                                <option value="1" selected>GET</option>
                                <option value="2">POST</option>
                                <option value="3">PUT</option>
                                <option value="4">DELETE</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-inline" role="form">
                        <div class="form-group">
                            <label for="url" class="control-label">接口URL: </label>
                            <input id="url" class="form-control" name="url" placeholder="请输入接口URL" th:value="${apiAndVerifyInfo.url}" style="width:1093px;"/>
                        </div>
                        <div class="form-group">
                            <label for="service_select_mod_api" class="control-label">所属服务: </label>
                            <select class="selectpicker" id="service_select_mod_api" data-width="175px"></select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-header"></i> Header </h3>
                </div>
                <div class="panel-body">
                    <div id="header_toolbar" class="btn-group" style="padding-bottom: 10px">
                        <button id="add_header_item" class="btn btn-primary" title="添加">
                            <i class="glyphicon glyphicon-plus"></i> 添加标准属性
                        </button>
                    </div>
                    <table class="table table-bordered">
                        <thead>
                            <th style="width: 235px">header类型</th>
                            <th>header内容</th>
                            <th style="width: 200px">操作</th>
                        </thead>
                        <tbody id="header_list"></tbody>
                    </table>
                    <div id="custom_header_toolbar" class="btn-group" style="padding-bottom: 10px">
                        <button id="add_custom_header_item" class="btn btn-primary" title="添加">
                            <i class="glyphicon glyphicon-plus"></i> 添加其他属性
                        </button>
                    </div>
                    <table class="table table-bordered">
                        <thead>
                            <th style="width: 235px">header类型</th>
                            <th>header内容</th>
                            <th style="width: 200px">操作</th>
                        </thead>
                        <tbody id="custom_header_list"></tbody>
                    </table>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-list"></i> 参数信息 </h3>
                </div>
                <div class="panel-body">
                    <ul id="myTab" class="nav nav-tabs">
                        <li class="active" id="param_li">
                            <a href="#parameters" data-toggle="tab">Parameters</a>
                        </li>
                        <li id="json_li">
                            <a href="#json" data-toggle="tab">JSON</a>
                        </li>
                    </ul>
                    <input type="hidden" id="body_type" name="bodyType" value="params"/>
                    <div id="myTabContent" class="tab-content">
                        <div class="tab-pane fade in active" id="parameters">
                            <div id="param_toolbar" class="btn-group" style="padding-bottom: 10px;padding-top: 10px">
                                <button id="add_param_item" class="btn btn-primary" title="添加">
                                    <i class="glyphicon glyphicon-plus"></i> 添加
                                </button>
                            </div>
                            <table class="table table-bordered">
                                <thead>
                                    <th style="width: 235px">参数名</th>
                                    <th>参数值</th>
                                    <th style="width: 200px">操作</th>
                                </thead>
                                <tbody id="param_list"></tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="json">
                            <textarea class="form-control" id="json_body" rows="9"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-check"></i> 响应验证 </h3>
                </div>
                <div class="panel-body">
                    <div id="verify_toolbar" class="btn-group" style="padding-bottom: 10px">
                        <button id="add_verify_item" class="btn btn-primary" title="添加">
                            <i class="glyphicon glyphicon-plus"></i> 添加
                        </button>
                    </div>
                    <table class="table table-bordered">
                        <thead>
                        <th style="width: 235px">验证名</th>
                        <th style="width: 235px">表达式类型</th>
                        <th>表达式</th>
                        <th>期望值</th>
                        <th style="width: 200px">操作</th>
                        </thead>
                        <tbody id="verify_list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="form-group">
            <label class="col-lg-2 control-label"></label>
            <div class="col-lg-10">
                <div class="pull-right">
                    <div class="btn-group">
                        <a th:href="'/apiList?serviceId='+${apiAndVerifyInfo.serviceId}" id="cancel_btn" type="button" class="btn btn-default">取消</a>
                    </div>
                    <span>&nbsp;&nbsp;</span>
                    <div class="btn-group">
                        <input id="submit_modify_btn" type="button" class="btn btn-primary" value="提交"/>
                    </div>
                    <span>&nbsp;&nbsp;</span>
                    <div class="btn-group">
                        <button id="perform_btn" type="button" class="btn btn-success" data-toggle="modal" data-target="#select_hosts_modal">执行</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--选择Hosts模态框-->
    <div class="modal fade" id="select_hosts_modal" tabindex="-1" role="dialog" aria-labelledby="selectHostsModal" aria-hidden="true">
        <div class="modal-dialog" role="document" style="width:1024px">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="selectHostsModal">选择Hosts</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="form-inline" role="form" style="padding-bottom: 10px">
                            <input type="hidden" id="hidden_api_id" name="apiId" th:value="${apiAndVerifyInfo.id}"/>
                            <input type="hidden" id="hidden_host_id" name="hostId" value=""/>
                            <div class="col-lg-12">
                                <div class="form-group">
                                    <table id="hosts_list" class="table table-bordered" style="table-layout: fixed;"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button id="execute_request_submit" type="button" class="btn btn-success">执行</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <!--显示HostsItem-->
    <div class="modal fade" id="show_host_item_modal" tabindex="-1" role="dialog" aria-labelledby="showHostItemModal" aria-hidden="true">
        <div class="modal-dialog" role="document" style="width:768px">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="showHostItemModal">映射地址列表</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="form-inline" role="form" style="padding-bottom: 10px">
                            <div class="col-lg-12">
                                <div class="form-group">
                                    <table id="host_item_table" class="table table-bordered" style="table-layout: fixed;">
                                        <thead>
                                            <th>IP</th>
                                            <th>URL</th>
                                        </thead>
                                        <tbody id="host_item_list"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <!--显示接口运行结果-->
    <div class="modal fade" id="response_verify_modal" tabindex="-1" role="dialog" aria-labelledby="responseVerifyModal" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog modal-lg" role="document" style="width:1440px">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="responseVerifyModal">响应结果</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div role="form" style="padding-bottom: 10px">
                            <div class="col-lg-1"></div>
                            <div class="col-lg-10">
                                <div class="form-group">
                                    <label for="result_api_name" class="control-label">接口名称:</label>
                                    <input id="result_api_name" class="form-control" name="apiName" value=""/>
                                </div>
                                <div class="form-group">
                                    <label for="result_url" class="control-label">URL:</label>
                                    <input id="result_url" class="form-control" name="url" value=""/>
                                </div>
                                <div class="form-group">
                                    <label for="result_status_code" class="control-label">状态码:</label>
                                    <input id="result_status_code" class="form-control" name="statusCode" value=""/>
                                </div>
                                <div class="form-group">
                                    <label for="result_resp_time" class="control-label">响应时间(毫秒):</label>
                                    <input id="result_resp_time" class="form-control" name="respTime" value=""/>
                                </div>
                                <div class="form-group">
                                    <label for="resp_header" class="control-label">响应Header:</label>
                                    <textarea class="form-control" id="resp_header" rows="10"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="resp_body" class="control-label">响应Body:</label>
                                    <textarea class="form-control" id="resp_body" rows="10"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="resp_verify" class="control-label">响应验证:</label>
                                    <table class="table table-bordered" id="resp_verify">
                                        <thead>
                                            <th>验证名</th>
                                            <th>期望值</th>
                                            <th>实际值</th>
                                            <th>是否通过</th>
                                        </thead>
                                        <tbody id="result_verify_list"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-lg-1"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <div class="modal fade" id="waitRespModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">提示</h4>
                </div>
                <div class="modal-body">
                    请求接口中,请稍候...
                </div>
            </div>
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <div class="modal fade" id="run_api_except_modal" tabindex="-1" role="dialog" aria-labelledby="runApiExceptModal" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document" style="width:1440px">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="runApiExceptModal">运行异常</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div role="form" style="padding-bottom: 10px">
                            <div class="col-lg-1"></div>
                            <div class="col-lg-10">
                                <div class="row" style="padding-bottom: 5px">
                                    <label for="except_textarea" class="control-label">URL:</label>
                                    <textarea class="form-control" id="except_textarea" rows="4" style="width: 100%"></textarea>
                                </div>
                                <div class="row">
                                    <label for="except_message" class="control-label">异常提示:</label>
                                    <input id="except_message" class="form-control" name="exceptMessage" value=""/>
                                </div>
                            </div>
                            <div class="col-lg-1"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // 获取请求协议
        var $protocol = $("#protocol");
        $protocol.selectpicker('val', [[${apiAndVerifyInfo.protocol}]]);
        // 获取请求方式
        var $method = $("#method");
        $method.selectpicker('val', [[${apiAndVerifyInfo.method}]]);
        // 动态获取Header表单
        var $header_list = $("#header_list");                                       // 拿到要动态生成的tbody
        var $custom_header_list = $("#custom_header_list");
        var headerItems = JSON.parse([[${apiAndVerifyInfo.header}]]);               // 拿到存储Header的JSON
        var header_item_index = 0;
        var custom_header_item_index = 0;
        var header_item_title_list = [
            'Accept',
            'Cache-Control',
            'Content-Type',
            'Cookie',
            'Host',
            'Referer',
            'User-Agent',
            'X-Requested-With'
        ];
        for (var headerItem in headerItems) {
            if ($.inArray(headerItem, header_item_title_list) !== -1) {
                header_item_index++;                                                    // ID下标累加
                var header_item_row = $("<tr></tr>");                                   // 添加一行

                var header_type_col = $("<td></td>");                                   // 添加类型列
                var $header_type_select = $("<select class='selectpicker header-type-select' id='header_type_select_" + header_item_index + "'></select>");
                $header_type_select.append("<option value='Accept'>Accept</option>");
                $header_type_select.append("<option value='Cache-Control'>Cache-Control</option>");
                $header_type_select.append("<option value='Content-Type'>Content-Type</option>");
                $header_type_select.append("<option value='Cookie'>Cookie</option>");
                $header_type_select.append("<option value='Host'>Host</option>");
                $header_type_select.append("<option value='Referer'>Referer</option>")
                $header_type_select.append("<option value='User-Agent'>User-Agent</option>");
                $header_type_select.append("<option value='X-Requested-With'>X-Requested-With</option>");
                $header_type_select.val(headerItem);                                    // 下拉框设置为从DB中读取的值(注意:直接用val)
                $header_type_select.appendTo(header_type_col);

                $header_type_select.selectpicker("refresh");
                $header_type_select.selectpicker("render");

                var header_content_col = $("<td></td>");                                // 添加内容列
                var $header_content_input = $('<input class="form-control header-value-input" style="width: 100%;" id="header_content_input"' + header_item_index + ' placeholder="header内容"/>');
                $header_content_input.val(headerItems[headerItem]);                     // 填入从DB获取的值
                $header_content_input.appendTo(header_content_col);

                var header_operator_col = $("<td></td>");                               // 添加操作列
                var $header_del_btn = $('<button/>', {
                    "class": "btn btn-default del_header_btn",
                    "id": "header_item_del_button_" + header_item_index,
                    "title": "删除"
                });
                var $iconHeader = $('<i/>', {"class": "glyphicon glyphicon-minus"});
                var $spanHeader = $("<span>&nbsp;删除</span>");
                $iconHeader.appendTo($header_del_btn);
                $spanHeader.appendTo($header_del_btn);
                $header_del_btn.appendTo(header_operator_col);

                header_item_row.append(header_type_col);
                header_item_row.append(header_content_col);
                header_item_row.append(header_operator_col);

                $header_list.append(header_item_row);
            } else {
                custom_header_item_index++;
                var custom_header_item_row = $("<tr></tr>");                                   // 添加一行

                var custom_header_type_col = $("<td></td>");                                   // 添加类型列
                var $custom_header_type_input = $('<input class="form-control header-name-input" style="width: 100%;" id="header_item_content_' + header_item_index + '" placeholder="header类型"/>');
                $custom_header_type_input.val(headerItem);                                    // 下拉框设置为从DB中读取的值(注意:直接用val)
                $custom_header_type_input.appendTo(custom_header_type_col);

                var custom_header_content_col = $("<td></td>");                                // 添加内容列
                var $custom_header_content_input = $('<input class="form-control header-value-input" style="width: 100%;" id="header_content_input"' + header_item_index + ' placeholder="header内容"/>');
                $custom_header_content_input.val(headerItems[headerItem]);                     // 填入从DB获取的值
                $custom_header_content_input.appendTo(custom_header_content_col);

                var custom_header_operator_col = $("<td></td>");                               // 添加操作列
                var $custom_header_del_btn = $('<button/>', {
                    "class": "btn btn-default del_header_btn",
                    "id": "custom_header_item_del_button_" + custom_header_item_index,
                    "title": "删除"
                });
                var $customIconHeader = $('<i/>', {"class": "glyphicon glyphicon-minus"});
                var $customSpanHeader = $("<span>&nbsp;删除</span>");
                $customIconHeader.appendTo($custom_header_del_btn);
                $customSpanHeader.appendTo($custom_header_del_btn);
                $custom_header_del_btn.appendTo(custom_header_operator_col);

                custom_header_item_row.append(custom_header_type_col);
                custom_header_item_row.append(custom_header_content_col);
                custom_header_item_row.append(custom_header_operator_col);

                $custom_header_list.append(custom_header_item_row);
            }
        }

        // 动态获取Body表单
        var $param_list = $("#param_list");                                         // 拿到存放参数的tbody
        var bodyJson = JSON.parse([[${apiAndVerifyInfo.body}]]);                    // 拿到存储Body的json
        if (headerItems.hasOwnProperty("Content-Type")) {                           // 如果Header中存在Content-Type字段
            if (headerItems['Content-Type'] === 'application/json') {
                $("#json_body").val(JSON.stringify(bodyJson, null, "\t"));

                $("#param_li").removeAttr("class");
                $("#json_li").attr("class", "active");

                $("#json").attr("class", "tab-pane fade in active");
                $("#parameters").attr("class", "tab-pane fade");
            } else if (headerItems['Content-Type'] === 'application/x-www-form-urlencoded') {
                paramAppend("post_param_del_btn");                                  // 传值是删除按钮的ID前缀

                $("#json_li").removeAttr("class");
                $("#param_li").attr("class", "active");

                $("#json").attr("class", "tab-pane fade");
                $("#parameters").attr("class", "tab-pane fade in active");
            }
        } else {                                                                    // 如果是其他Content-Type的请求
            paramAppend("get_param_del_btn");                                       // 传值是删除按钮的ID前缀

            $("#json_li").removeAttr("class");
            $("#param_li").attr("class", "active");

            $("#json").attr("class", "tab-pane fade");
            $("#parameters").attr("class", "tab-pane fade in active");
        }

        // 获取Get/Post表单的通用方法
        function paramAppend(param_del_btn) {
            var param_item_index = 0;
            for (var paramItem in bodyJson) {
                param_item_index++;
                var param_item_row = $("<tr></tr>");

                var param_name_col = $("<td></td>");
                var $param_name_input = $('<input class="form-control param-name-input" style="width: 100%;" id="param_name_input_"' + param_item_index + ' placeholder="参数名"/>');
                $param_name_input.val(paramItem);                                   // 从DB获取参数名
                $param_name_input.appendTo(param_name_col);

                var param_value_col = $("<td></td>");
                var $param_value_input = $('<input class="form-control param-value-input" style="width: 100%;" id="param_value_input_"' + param_item_index + ' placeholder="参数值"/>');
                $param_value_input.val(bodyJson[paramItem]);
                $param_value_input.appendTo(param_value_col);

                var param_operator_col = $("<td></td>");                            // 添加操作列
                var $param_del_btn = $('<button/>', {
                    "class": "btn btn-default del_param_btn",
                    "id": param_del_btn + '_' + param_item_index,
                    "title": "删除"
                });
                var $iconParam = $('<i/>', {"class": "glyphicon glyphicon-minus"});
                var $spanParam = $("<span>&nbsp;删除</span>");
                $iconParam.appendTo($param_del_btn);
                $spanParam.appendTo($param_del_btn);
                $param_del_btn.appendTo(param_operator_col);

                param_item_row.append(param_name_col);
                param_item_row.append(param_value_col);
                param_item_row.append(param_operator_col);

                $param_list.append(param_item_row);
            }
        }

        // 动态获取验证表单
        var $verify_list = $("#verify_list");
        var verifyList = eval([[${apiAndVerifyInfo.verifyList}]]);
        for (var index in verifyList) {
            var verify_item_row = $("<tr></tr>");
            var verify_item_id = $('<input type="hidden" class="verify-id" id="verify_id_' + index + '" name="verifyId" value="' + verifyList[index].id + '"/>');

            var verify_name_col = $("<td></td>");
            var $verify_name_input = $('<input class="form-control verify-name-input" style="width: 100%;" id="verify_name_input"' + index + ' placeholder="验证名"/>');
            $verify_name_input.val(verifyList[index].verifyName);
            $verify_name_input.appendTo(verify_name_col);

            var verify_type_col = $("<td></td>");
            var $verify_type_select = $("<select class='selectpicker verify-type-select' id='verify_type_select_" + index + "'></select>");
            $verify_type_select.append("<option value=" + 1 + ">Regex</option>");
            $verify_type_select.append("<option value=" + 2 + ">JSONPath</option>");
            $verify_type_select.append("<option value=" + 3 + ">CSS Selector</option>");
            $verify_type_select.val(verifyList[index].verifyType);
            $verify_type_select.appendTo(verify_type_col);

            $verify_type_select.selectpicker("refresh");
            $verify_type_select.selectpicker("render");

            var verify_expression_col = $("<td></td>");
            var $verify_expression_input = $('<input class="form-control verify-expression-input" style="width: 100%;" id="verify_expression_input_"' + index + ' placeholder="表达式"/>');
            $verify_expression_input.val(verifyList[index].expression);
            $verify_expression_input.appendTo(verify_expression_col);

            var verify_expect_col = $("<td></td>");
            var $verify_expect_input = $('<input class="form-control verify-expect-input" style="width: 100%;" id="verify_expect_input_"' + index + ' placeholder="期望值"/>');
            $verify_expect_input.val(verifyList[index].expectValue);
            $verify_expect_input.appendTo(verify_expect_col);

            var verify_operator_col = $("<td></td>");
            var $verify_del_btn = $('<button/>', {
                "class": "btn btn-default del_verify_btn",
                "id": "verify_item_del_button_" + index,
                "title": "删除"
            });
            var $icon = $('<i/>', {"class": "glyphicon glyphicon-minus"});
            var span_del = $("<span>&nbsp;删除</span>");
            $icon.appendTo($verify_del_btn);
            $verify_del_btn.append(span_del);
            $verify_del_btn.appendTo(verify_operator_col);

            verify_item_row.append(verify_item_id);
            verify_item_row.append(verify_name_col);
            verify_item_row.append(verify_type_col);
            verify_item_row.append(verify_expression_col);
            verify_item_row.append(verify_expect_col);
            verify_item_row.append(verify_operator_col);

            $verify_list.append(verify_item_row);
        }
        /*]]>*/
    </script>
</div>
</body>
</html>